import faiss
import pickle
import numpy as np
from openai import OpenAI
from dotenv import load_dotenv

FEW_SHOTS = """
ğŸ‘©â€ğŸ« ì±—ë´‡:
ì•ˆë…•í•˜ì„¸ìš”.
ì•„ì´ê°€ ì¹œêµ¬ë“¤ê³¼ ì˜ ì–´ìš¸ë¦¬ì§€ ëª»í•˜ê³  ì†Œì‹¬í•œ ëª¨ìŠµì„ ë³´ì¸ë‹¤ê³  í•˜ì…¨ì£ .
ê±±ì •ì´ í¬ì‹¤ ê±°ì˜ˆìš”.
ìë…€ì˜ ë‚˜ì´, ì„±ë³„, ì§€ì—­ì„ ì•Œë ¤ì£¼ì‹œë©´ ë¨¼ì € ì›ì¸ì„ í•¨ê»˜ ë¶„ì„í•´ë³¼ê²Œìš”.

ğŸ‘© ë¶€ëª¨:
6ì‚´ ì—¬ìì•„ì´, ì„œìš¸ì´ì—ìš”.

ğŸ‘©â€ğŸ« ì±—ë´‡:
ê°ì‚¬í•©ë‹ˆë‹¤.
ê·¸ëŸ¼ ì•„ì´ê°€ ë˜ë˜ ê´€ê³„ì—ì„œ ìœ„ì¶•ë  ìˆ˜ ìˆëŠ” ì‹¬ë¦¬ì  ì›ì¸ì„ ë¨¼ì € ì‚´í´ë³¼ê²Œìš”.

ğŸ” ì›ì¸ â‘  â€“ ì•ˆì • ì• ì°© ë¶€ì¡±

ì•„ì´ê°€ ì¹œêµ¬ë“¤ ì‚¬ì´ì—ì„œ ìœ„ì¶•ë˜ëŠ” ê±´,
ë¶€ëª¨ì™€ì˜ ì•ˆì •ëœ ì• ì°©ì´ ì¶©ë¶„íˆ í˜•ì„±ë˜ì§€ ì•Šì•˜ì„ ë•Œ ìƒê¸¸ ìˆ˜ ìˆì–´ìš”.
ë¶€ëª¨ê°€ ëŠ˜ ì¼ê´€ë˜ê²Œ ë°˜ì‘í•´ì£¼ì§€ ëª»í–ˆê±°ë‚˜, ê°ì • í‘œí˜„ì„ ì•ˆì „í•˜ê²Œ í•  ê¸°íšŒê°€ ë¶€ì¡±í–ˆë‹¤ë©´
ì•„ì´ëŠ” ìì‹ ì„ í‘œí˜„í•˜ëŠ” ë° ì–´ë ¤ì›€ì„ ëŠë‚„ ìˆ˜ ìˆì£ .
ì˜ˆë¥¼ ë“¤ì–´, ì†ìƒí•  ë•Œ â€œê·¸ëŸ´ ìˆ˜ë„ ìˆì§€â€ë³´ë‹¤ëŠ” â€œì™œ ê·¸ëŸ° ê±¸ë¡œ ìš¸ì–´?â€ ê°™ì€ ë°˜ì‘ì„ ìì£¼ ë“¤ì—ˆë‹¤ë©´,
ì•„ì´ëŠ” ì ì  ìê¸° ê°ì •ì„ ìˆ¨ê¸°ê²Œ ë¼ìš”.
ë˜í•œ, ì‹ ì²´ì  ì• ì • í‘œí˜„ì´ë‚˜ ê·œì¹™ì ì¸ ìƒí™œì´ ë¶€ì¡±í•˜ë©´ ì•„ì´ëŠ” ê¸°ë³¸ì ì¸ ì•ˆì •ê°ì„ ëœ ëŠë¼ê²Œ ë¼ìš”.
ì´ëŸ° ë¶ˆì•ˆì •í•¨ì´ ìŒ“ì´ë©´, ë‚¯ì„  ìƒí™©ì´ë‚˜ ë˜ë˜ ê´€ê³„ì—ì„œë„ ì‰½ê²Œ ì£¼ëˆ…ì´ ë“¤ ìˆ˜ ìˆì–´ìš”.
ê·¸ë˜ì„œ ì•„ì´ê°€ ì†Œì‹¬í•œ ëª¨ìŠµì´ë¼ë©´, ì´ëŸ° ì´ˆê¸° ì• ì°© ê²½í—˜ì„ í•¨ê»˜ ëŒì•„ë³´ëŠ” ê²ƒë„ í•„ìš”í•´ìš”.

ğŸŸ¡ ì´ ì›ì¸ì´ ë§ëŠ” ê²ƒ ê°™ë‚˜ìš”?
ğŸ‘‰ [ë„¤, ê·¸ëŸ° ê²ƒ ê°™ì•„ìš”] / [ì˜ ëª¨ë¥´ê² ì–´ìš”] / [ë‹¤ë¥¸ ì›ì¸ë„ ë³´ê³  ì‹¶ì–´ìš”]

ğŸ” ì›ì¸ â‘¡ â€“ ì£¼ë„ì„± ë°œë‹¬ ê¸°íšŒ ë¶€ì¡± (ì—ë¦­ìŠ¨ì˜ ì´ë¡ )

ì•„ì´ê°€ ì†Œì‹¬í•´ ë³´ì´ëŠ” ê±´,
ìì‹ ê°ì„ í‚¤ìš°ëŠ” ì‹œê¸°ì— ì¶©ë¶„í•œ 'ì‹œë„ ê²½í—˜'ì„ í•˜ì§€ ëª»í–ˆê¸° ë•Œë¬¸ì¼ ìˆ˜ë„ ìˆì–´ìš”.
ì—ë¦­ìŠ¨ì˜ ë°œë‹¬ì´ë¡ ì— ë”°ë¥´ë©´, ì´ ì‹œê¸° ì•„ì´ëŠ” ìŠ¤ìŠ¤ë¡œ í•´ë³´ëŠ” ê²½í—˜ì„ í†µí•´ 'ì£¼ë„ì„±'ì„ í˜•ì„±í•´ìš”.
ê·¸ëŸ°ë° ëˆ„êµ°ê°€ ëŒ€ì‹  í•´ì£¼ê±°ë‚˜, ì‹œë„í•  ë•Œë§ˆë‹¤ â€œìœ„í—˜í•´â€, â€œì§€ê¸ˆì€ ì•ˆ ë¼â€ë¼ëŠ” ì œì§€ë¥¼ ìì£¼ ë°›ì•˜ë‹¤ë©´
ì•„ì´ëŠ” ì ì  â€œë‚˜ëŠ” ëª» í•´â€, â€œí•˜ë©´ ì•ˆ ë˜ëŠ” ê±°ì•¼â€ë¼ê³  ëŠë¼ê²Œ ë¼ìš”.
ì‹¤íŒ¨í•˜ê±°ë‚˜ ì‹œë„í•  ê¸°íšŒê°€ ì ì—ˆë˜ ì•„ì´ëŠ”, ì²˜ìŒë¶€í„° ë„ì „ ìì²´ë¥¼ ë‘ë ¤ì›Œí•˜ê²Œ ë¼ìš”.
ê·¸ë˜ì„œ ì¹œêµ¬ì™€ ì–´ìš¸ë¦¬ëŠ” ìƒí™©ì—ì„œë„ ì‰½ê²Œ ì›€ì¸ ëŸ¬ë“¤ê³ , ëŒ€í™”ë‚˜ ë†€ì´ë¥¼ í”¼í•˜ê²Œ ë˜ëŠ” ê±°ì˜ˆìš”.
ì•„ì´ê°€ ì†Œì‹¬í•œ ê±´ ì„±ê²©ì´ë¼ê¸°ë³´ë‹¤ëŠ”, ì£¼ë„ì„±ì„ í‚¤ìš¸ í™˜ê²½ì´ ë¶€ì¡±í–ˆë˜ ê²ƒì¼ ìˆ˜ ìˆì–´ìš”.

ğŸ‘©â€ğŸ« ì±—ë´‡:
ì´ëŸ° ì›ì¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ,
ì•„ì´ê°€ ì¹œêµ¬ê°€ ì—†ë‹¤ê³  ë§í•  ë•Œ ì–´ë–¤ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©´ ì¢‹ì„ì§€ í•¨ê»˜ ì•Œì•„ë³¼ê¹Œìš”?

ğŸ—£ï¸ ìƒí™©ë³„ ëŒ€í™” ì˜ˆì‹œ
ğŸ§’ â€œì¹œêµ¬ë“¤ì´ ë‹¤ ë¬´ë¦¬ ì§€ì–´ì„œ ë‚˜ë§Œ í˜¼ìì•¼.â€
ğŸ‘© â€œê·¸ë˜ì„œ ì™¸ë¡­ê³ , ë‚˜ë§Œ ë¹ ì§„ ê²ƒ ê°™ì•˜ê² ë‹¤.
ë¬´ë¦¬ ì†ì— ë“¤ì–´ê°€ëŠ” ê²Œ ê´œíˆ ì–´ë µê³  ëˆˆì¹˜ë„ ë³´ì˜€ì„ ê±°ì•¼.
ê·¸ì¹˜ë§Œ ê¼­ ë§ì€ ì¹œêµ¬ê°€ í•„ìš”í•œ ê±´ ì•„ë‹ˆì•¼.
í¸í•œ ì¹œêµ¬ í•œ ëª…ë§Œ ìˆì–´ë„ ê´œì°®ì•„.
â€˜ê°™ì´ â—‹â—‹ í•´ë„ ë¼?â€™ í•˜ê³  ì²œì²œíˆ ë‹¤ê°€ê°€ë³´ì.â€

ğŸ§’ â€œë§Œì•½ ê±”ê°€ ë‚˜ë‘ ë†€ê¸° ì‹«ì–´í•˜ë©´ ì–´ë–¡í•´?â€
ğŸ‘© â€œê·¸ëŸ° ê±±ì •ì´ ë“œëŠ” ê±°, ì •ë§ ì´í•´ë¼.
ê±°ì ˆë‹¹í•˜ë©´ ì†ìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆê¹Œ.
ê·¼ë° ì¹œêµ¬ë“¤ë„ ê·¸ë‚ ê·¸ë‚  ê¸°ë¶„ì´ ë‹¬ë¼.
ë„ˆëŠ” ë‹¤ê°€ê°ˆ ìˆ˜ ìˆëŠ” ìš©ê¸°ë¥¼ ê°€ì§„ ì•„ì´ì•¼.â€

ğŸ§’ â€œê°™ì´ í•˜ìê³  í•´ë„ ê³„ì† ë‹¤ë¥¸ ì• ë“¤ë§Œ ë¼ì›Œì¤˜.â€
ğŸ‘© â€œì†ìƒí•˜ì§€, ì™œ ë‚˜ë§Œ ì•ˆ ë˜ëŠ” ê±°ì§€ ì‹¶ì€ ë§ˆìŒ ë“¤ ê±°ì•¼.
ê·¸ë˜ë„ ë„ˆëŠ” ê³„ì† ìš©ê¸° ë‚´ê³  ìˆì–ì•„.
ê·¸ê²Œ ì–¼ë§ˆë‚˜ ëŒ€ë‹¨í•œ ì¼ì¸ì§€ ì•Œì•„?
ê·¸ëŸ° ì§„ì‹¬ì„ ì•Œì•„ë´ì£¼ëŠ” ì¹œêµ¬ëŠ” ê¼­ ë‚˜íƒ€ë‚  ê±°ì•¼.â€

ğŸ§’ â€œí˜¼ì ìˆëŠ” ê²Œ ë” í¸í•´.â€
ğŸ‘© â€œê·¸ë˜, í˜¼ì ìˆëŠ” ê²Œ í¸í•  ë•Œë„ ìˆì–´.
ë„¤ê°€ ë„ˆ ìì‹ ì„ ì˜ ì•„ëŠ” ê±°ì•¼.
ë¬´ë¦¬ì— ê¼­ ë¼ì§€ ì•Šì•„ë„ ë¼.
í•˜ì§€ë§Œ ì–¸ì  ê°€ ëˆ„êµ°ê°€ ê³ì— ìˆì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤ê³  ëŠë‚€ë‹¤ë©´,
ì¡°ìš©íˆ í•¨ê»˜ ìˆëŠ” ë°©ë²•ë„ ìˆë‹¤ëŠ” ê±¸ ê¸°ì–µí•´ì¤˜.â€

ğŸ‘©â€ğŸ« ì±—ë´‡:
ë‹¤ìŒìœ¼ë¡œ, ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ë§ì€ ë¬´ì—‡ì¸ì§€ í•¨ê»˜ ìƒê°í•´ë³¼ê¹Œìš”?

ğŸ‘‰ [ì‘] í´ë¦­

ğŸ‘© ë¶€ëª¨:
ì‘

ğŸ‘©â€ğŸ« ì±—ë´‡:
ë§ì€ ë¶€ëª¨ë‹˜ì´ ì„ ì˜ë¡œ ì´ë ‡ê²Œ ë§í•˜ê³¤ í•´ìš”.
âŒ â€œë„¤ê°€ ë¨¼ì € ë‹¤ê°€ê°€ì§€ ì•Šìœ¼ë‹ˆê¹Œ ê·¸ë ‡ì§€.â€
í•˜ì§€ë§Œ ì•„ì´ ì…ì¥ì—ì„œëŠ” **â€œë‚´ê°€ ë¬¸ì œë¼ì„œ ì¹œêµ¬ê°€ ì—†ëŠ” ê±°ì•¼â€**ë¼ê³  ëŠë‚„ ìˆ˜ ìˆì–´ìš”.
ì´ëŸ° ë§ì€ ìì¡´ê°ì„ ë–¨ì–´ëœ¨ë¦¬ê³ , ë” ì›€ì¸ ëŸ¬ë“¤ê²Œ ë§Œë“¤ì–´ìš”.

âœ” ëŒ€ì‹  ì´ë ‡ê²Œ ë§í•´ë³´ì„¸ìš”:

â€œì¹œêµ¬í•œí…Œ ë¨¼ì € ë‹¤ê°€ê°€ëŠ” ê²Œ ì–´ë ¤ì› ì„ ìˆ˜ë„ ìˆê² ë„¤.
ì–´ë–¤ ìˆœê°„ì´ ì œì¼ í˜ë“¤ì—ˆì–´?â€

ğŸ‘©â€ğŸ« ì±—ë´‡:
ì´ì œ, ê°€ì •ì—ì„œ ì•„ì´ì˜ ì‚¬íšŒì„±ì„ ê¸°ë¥¼ ìˆ˜ ìˆëŠ” ì‹¤ì²œ íŒë„ ì•Œë ¤ë“œë¦´ê²Œìš”.
ğŸ‘‰ [ì‘] í´ë¦­

ğŸ‘© ë¶€ëª¨:
ì‘

ğŸ‘©â€ğŸ« ì±—ë´‡:
ì•„ì´ê°€ ì¹œêµ¬ ê´€ê³„ì— ìì‹ ê°ì„ ê°–ë„ë¡,
ê°€ì •ì—ì„œ ì´ë ‡ê²Œ ì—°ìŠµí•´ë³´ì„¸ìš”.

ğŸ”¹ 1. í•˜ë£¨ í•œ ë²ˆ 'ë§ˆìŒ ëŒ€í™”' ë‚˜ëˆ„ê¸°
ì˜ˆ: â€œì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë• ì–´?â€, â€œì¹œêµ¬ë‘ ë­ í–ˆì–´?â€
â†’ ê°ì • í‘œí˜„, ê³µê°, ê°ˆë“± ëŒ€ì²˜ë ¥ í–¥ìƒ
ğŸ“Š 8ì£¼ê°„ ì‹¤ì²œí•œ ê°€ì •: ê³µê°ë ¥Â·ê°ì • ì¡°ì ˆë ¥ 30%â†‘

ğŸ”¹ 2. ì¹œêµ¬ì—ê²Œ ë§ ê±°ëŠ” ë¬¸ì¥ ì—°ìŠµ
ì˜ˆ: â€œë‚˜ë„ ê»´ì¤˜~â€, â€œê°™ì´ í•´ë„ ë¼?â€
â†’ ìƒí™©ë³„ í‘œí˜„ì— ìµìˆ™í•´ì§€ë©´ ë§ ê±¸ê¸°ê°€ í›¨ì”¬ ì‰¬ì›Œì ¸ìš”
ğŸ“Š í›ˆë ¨í•œ ì•„ì´ëŠ” ì¹œêµ¬ì—ê²Œ ë§ ê±°ëŠ” ì„±ê³µë¥  2ë°°â†‘

ğŸ”¹ 3. ì—­í• ë†€ì´ (ë¶€ëª¨ê°€ ì¹œêµ¬ ì—­í• )
ì˜ˆ: â€œì¹œêµ¬ê°€ ìê¸° ë§ë§Œ í•´. ë­ë¼ê³  í• ë˜?â€
â†’ í˜„ì‹¤ ëŒ€ì²˜ë ¥, ëŒ€í™” ìš©ê¸° í‚¤ìš°ëŠ” ë° íš¨ê³¼ì 
ğŸ“Š 6ì£¼ê°„ ì‹¤ì²œ ì‹œ ëŒ€í™” ì „ëµ ì ìˆ˜ 28%â†‘

ğŸ“Œ ì´ ëŒ€í™”ë¥¼ ì €ì¥í•´ë‘ì‹œê³ ,
2ì£¼ ë’¤ ì•„ì´ì—ê²Œ ì–´ë–¤ ë³€í™”ê°€ ìƒê²¼ëŠ”ì§€ í•¨ê»˜ ì ê²€í•´ë³´ì„¸ìš”.

í•„ìš”í•˜ì‹œë©´ ì´í›„
âœ… ê°ì • ë³€í™” ë¦¬í¬íŠ¸ ë°›ê¸°
âœ… ì¶”ê°€ ì‹¤ì²œ ê³¼ì œ
âœ… êµì‚¬/ì „ë¬¸ê°€ì™€ ì—°ê²°í•˜ê¸°
ë„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”. ì›í•˜ì‹œë‚˜ìš”?
"""

load_dotenv()
client = OpenAI()

# === FAISS & chunks ë¶ˆëŸ¬ì˜¤ê¸° ===
index = faiss.read_index("faiss_index.idx")

with open("faiss_chunks.pkl", "rb") as f:
    chunks = pickle.load(f)


# === ì„ë² ë”© í•¨ìˆ˜ ===
def get_embedding(text: str) -> list[float]:
    response = client.embeddings.create(input=[text], model="text-embedding-3-small")
    return response.data[0].embedding


# === ê²€ìƒ‰ í•¨ìˆ˜ ===
def retrieve_relevant_chunks(query: str, top_k: int = 5) -> list[str]:
    query_vector = np.array(get_embedding(query)).astype("float32").reshape(1, -1)
    D, I = index.search(query_vector, top_k)
    return [chunks[i] for i in I[0]]


# === Chat API í˜¸ì¶œ í•¨ìˆ˜ (ëŒ€í™” ì´ë ¥ ì§€ì›) ===
def ask_rag_chatbot(query: str, chat_history: list[dict]) -> str:
    docs = retrieve_relevant_chunks(query, top_k=3)
    rag_text = ""
    for doc in docs:
        rag_text += f"""----------------------
{doc.get("chapter", "")}{doc.get("section", "")}
{doc.get("doc", "")}
----------------------
"""

    system_prompt_format = """ë‹¹ì‹ ì€ ì•„ë™ ìƒë‹´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì°¸ê³ ë¥¼ ìœ„í•´ ì£¼ì–´ì§„ ì •ë³´ëŠ” ì•„ë™ì‹¬ë¦¬ ì „ë¬¸ ì„œì ì—ì„œ ì‚¬ìš©ìì˜ ë°œí™”ì™€ ê´€ë ¨ëœ ë‚´ìš©ì„ ì°¾ì€ ê²ƒì…ë‹ˆë‹¤.
í•´ë‹¹ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ì‰½ê³  ìµœëŒ€í•œ êµ¬ì²´ì ìœ¼ë¡œ ë‹µë³€ì„ ì£¼ì„¸ìš”.

### ì°¸ê³ í•  ì´ë¡ 
{rag_text}

### ë‹µë³€ ì‘ì„± ì§€ì¹¨
ëŒ€ì•ˆì„ ì œì‹œí•˜ê¸°ë³´ë‹¤ëŠ” ì°¾ì€ ë‚´ìš©ì„ í™œìš©í•´ì„œ ì´ë¡ ì ì¸ ë¶„ì„ì„ í•˜ëŠ” ë° ì¤‘ì ì„ ë‘ì„¸ìš”.
ë‹µë³€ì„ í•  ë•Œ ë‹¤ìŒì˜ ì˜ˆì‹œë¥¼ ì°¸ê³ í•´ì„œ ë¹„ìŠ·í•œ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ ì£¼ì„¸ìš”.
í˜•ì‹ë§Œ ì°¸ê³ í•˜ê³ , ë‚´ìš©ì€ ìœ„ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.

### ì˜ˆì‹œ
{few_shots}
    """

    system_prompt = system_prompt_format.format(rag_text=rag_text, few_shots=FEW_SHOTS)

    print("System Prompt:", system_prompt)  # ë””ë²„ê¹…ìš© ì¶œë ¥

    messages = [{"role": "system", "content": system_prompt}] + chat_history
    messages.append(
        {
            "role": "user",
            "content": query,
        }
    )

    response = client.chat.completions.create(
        model="gpt-4.1-mini", messages=messages, temperature=0.2
    )
    return response.choices[0].message.content.strip()
